/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package View;

import conexoes.ConexaoFB;
import conexoes.ConexaoMySQL;
import java.awt.Dimension;
import java.sql.SQLException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author luiz.barcellos
 */
public class Importar_Automatico extends javax.swing.JInternalFrame {

    /**
     * Creates new form Importar_Automatico
     */
    public Importar_Automatico() {
        initComponents();
    }

    DateFormat dateOut = new SimpleDateFormat("yyyy/MM/dd");
    DateFormat dateIn = new SimpleDateFormat("dd/MM/yyyy");

    ConexaoMySQL cn = new ConexaoMySQL();
    ConexaoFB fb = new ConexaoFB();

    public void setPosicao() {
        Dimension d = this.getDesktopPane().getSize();
        this.setLocation((d.width - this.getSize().width) / 2, (d.height - this.getSize().height) / 2);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jBtnPesquisar = new javax.swing.JButton();
        jTxtDataInicial = new javax.swing.JTextField();
        jLabel1 = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTblNotas = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        jBtnImportar = new javax.swing.JButton();
        jBtnCancelar = new javax.swing.JButton();

        setTitle("Importação de Notas Fiscais");

        jBtnPesquisar.setText("Pesquisar");
        jBtnPesquisar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnPesquisarActionPerformed(evt);
            }
        });

        jLabel1.setText("A partir de");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jTxtDataInicial, javax.swing.GroupLayout.PREFERRED_SIZE, 133, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jBtnPesquisar, javax.swing.GroupLayout.PREFERRED_SIZE, 108, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(963, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addContainerGap(14, Short.MAX_VALUE)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jTxtDataInicial, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jBtnPesquisar))
                .addContainerGap())
        );

        jTblNotas.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {

            }
        ));
        jScrollPane1.setViewportView(jTblNotas);

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 0, Short.MAX_VALUE)
            .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(jPanel2Layout.createSequentialGroup()
                    .addContainerGap()
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 616, Short.MAX_VALUE)
                    .addContainerGap()))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 333, Short.MAX_VALUE)
            .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(jPanel2Layout.createSequentialGroup()
                    .addContainerGap()
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 311, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
        );

        jBtnImportar.setText("Importar");
        jBtnImportar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnImportarActionPerformed(evt);
            }
        });

        jBtnCancelar.setText("Cancelar");
        jBtnCancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jBtnCancelarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jBtnCancelar)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jBtnImportar)
                .addContainerGap())
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jBtnImportar)
                    .addComponent(jBtnCancelar))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jPanel2, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jBtnCancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnCancelarActionPerformed
        this.dispose();
    }//GEN-LAST:event_jBtnCancelarActionPerformed

    private void jBtnPesquisarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnPesquisarActionPerformed

        MontaLista();

    }//GEN-LAST:event_jBtnPesquisarActionPerformed

    private void jBtnImportarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jBtnImportarActionPerformed
        String sql3 = "INSERT INTO `cad_notas_fiscais` (`numero_nf`,`serie_nf`,"
                + "`quantidade`,`valor`,`data_emissao`,`nome_terceiro`,"
                + "`cnpj_terceiro`,`natureza`,`cnpj_proprio`,`produto`,`ncmsh`,"
                + "`destino`,`uf_destino`,`nf_referenciada`) "
                + " SELECT * FROM notas_fiscais_novas ";

        cn.conecta();
        cn.executeAtualizacao("TRUNCATE tmp_cad_notas_fiscais;");

        ConsultaFB();

        try {
            while (fb.rs.next()) {

                try {
                    String numero = fb.rs.getString(1);
                    String serie = fb.rs.getString(2);
                    String qtd = fb.rs.getString(3);
                    String valor = fb.rs.getString(4);
                    String emissao = fb.rs.getString(5);
                    String terceiro = fb.rs.getString(6);
                    String cnpj1 = fb.rs.getString(7);
                    String natureza = fb.rs.getString(8);
                    String cnpj2 = fb.rs.getString(9);
                    String produto = fb.rs.getString(10);
                    String ncm = fb.rs.getString(11);
                    String destino = fb.rs.getString(12);
                    String uf = fb.rs.getString(13);
                    String referencia = fb.rs.getString(14);

                    String sqlmy = "INSERT into tmp_cad_notas_fiscais (numero_nf,"
                            + "serie_nf,quantidade,valor,data_emissao,nome_terceiro,"
                            + "cnpj_terceiro,natureza,cnpj_proprio,produto,ncmsh,"
                            + "destino,uf_destino,nf_referenciada) VALUES ("
                            + "'" + numero + "','" + serie + "','" + qtd + "','" + valor + "',"
                            + "'" + emissao + "','" + terceiro + "','" + cnpj1 + "',"
                            + "'" + natureza + "','" + cnpj2 + "','" + produto + "',"
                            + "'" + ncm + "','" + destino + "','" + uf + "'," + referencia + ");";

                    cn.executeAtualizacao(sqlmy);

                } catch (NullPointerException e) {
                    JOptionPane.showMessageDialog(this, e);
                }
            }
        } catch (SQLException ex) {

            JOptionPane.showMessageDialog(this, "Erro ao consultar o banco de dados: " + ex);
        }

        String registros = null;
        cn.executeConsulta("SELECT count(cnpj_proprio) FROM notas_fiscais_novas;");
        try {
            while (cn.rs.next()) {
                registros = cn.rs.getString(1);
            }
            cn.executeAtualizacao(sql3);
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, e);
        } finally {
            cn.desconecta();
            fb.desconecta();
        }

        JOptionPane.showMessageDialog(this, registros + " notas importadas!");


    }//GEN-LAST:event_jBtnImportarActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jBtnCancelar;
    private javax.swing.JButton jBtnImportar;
    private javax.swing.JButton jBtnPesquisar;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable jTblNotas;
    private javax.swing.JTextField jTxtDataInicial;
    // End of variables declaration//GEN-END:variables

    private void ConsultaFB() {

        String dti = jTxtDataInicial.getText().replace("/", ".");

        String sql = " with especie_doc as ( "
                + "select d.empresa, d.codigo, d.nome as especie_doc, d.modelo_doc "
                + "from cad_especie_doc d "
                + "where d.importa_fiscal = 'S') "
                + "select np.codigo as numero_nf, np.serie, np.quantidade, "
                + " np.vlr_contabil_item as valor, n.dt_emissao as data_emissao, "
                + "t.nome as nome_terceiro, t.cpf_cnpj as cnpj_terceiro, "
                + "o.nome as natureza, replace(replace(replace(e.cnpj,'-',''),'/',''),'.','') as cnpj_proprio, "
                + "p.nome_reduzido as produto, p.ncm as ncmsh, md.nome as destino, "
                + "md.uf as uf_destino, 0 as nf_referenciada "
                + "from ven_notafiscal_produtos np "
                + "inner join ven_notafiscal n on (np.empresa=n.empresa and np.codigo=n.codigo and np.serie=n.serie) "
                + "inner join especie_doc d on (n.empresa=d.empresa and n.especie=d.codigo) "
                + "left join cad_produtos p on (np.empresa=p.empresa and np.produto=p.codigo) "
                + "left join cad_operacoes_fisc o on (np.empresa=o.empresa and np.operacao=o.codigo) "
                + "left join cad_estabelecimentos e on (n.empresa=e.empresa and n.estabelec=e.codigo) "
                + "left join cad_terceiros t on (t.empresa=n.empresa and t.codigo=n.cliente) "
                + "left join cad_terceiros_enderecos te on (te.empresa=n.empresa and te.codigo=n.cliente and te.sequencia=n.endereco) "
                + "left join cad_municipios md on (md.codigo=te.municipio) "
                + "where (n.dt_emissao between '" + dti + "' and current_date) "
                + "and (n.tipo_nf = 'S') and (n.cancelada != 'S' or n.cancelada is null) "
                + "and (d.modelo_doc <> '55' or((d.modelo_doc = '55' and n.nfe_status = 'AU' ) )) "
                + "and ((np.operacao = '2109' or np.operacao = '2112') or (np.operacao = '2104' and n.cliente = '1688')) "
                + "union all "
                + "select np.codigo as numero_nf, np.serie,np.quantidade,np.vlr_contabil_item as valor, "
                + "n.dt_emissao as data_emissao,t.nome as nome_terceiro,t.cpf_cnpj as cnpj_terceiro, "
                + "o.nome as natureza,replace(replace(replace(e.cnpj, '-',''),'/',''),'.','') as cnpj_proprio, "
                + "p.nome_reduzido as produto,p.ncm as ncmsh,md.nome as destino, "
                + "md.uf as uf_destino,n.ref_nf as nf_referenciada "
                + "from ven_notafiscal_produtos np "
                + "inner join ven_notafiscal n on(np.empresa = n.empresa and np.codigo = n.codigo and np.serie = n.serie) "
                + "inner join especie_doc d on(n.empresa = d.empresa and n.especie = d.codigo) "
                + "left join cad_produtos p on(np.empresa = p.empresa and np.produto = p.codigo) "
                + "left join cad_operacoes_fisc o on(np.empresa = o.empresa and np.operacao = o.codigo) "
                + "left join cad_estabelecimentos e on(n.empresa = e.empresa and n.estabelec = e.codigo) "
                + "left join cad_terceiros t on(t.empresa = n.empresa and t.codigo = n.cliente) "
                + "left join cad_terceiros_enderecos te on(te.empresa = n.empresa and te.codigo = n.cliente and te.sequencia = n.endereco)"
                + "left join cad_municipios md on(md.codigo = e.municipio) "
                + "where(n.dt_emissao between '" + dti + "' and current_date) "
                + "and(n.tipo_nf = 'E') "
                + "and(n.cancelada <> 'S' or n.cancelada is null) "
                + "and(d.modelo_doc <> '55' or((d.modelo_doc = '55' and n.nfe_status = 'AU') )) "
                + "and np.operacao = '6312' "
                + "ORDER BY 5;";

        fb.conecta();
        fb.executeConsulta(sql);
    }

    private void MontaLista() {
        DefaultTableModel lista = (DefaultTableModel) jTblNotas.getModel();

        lista.setColumnCount(0);
        lista.setRowCount(0);

        lista.addColumn("Número");
        lista.addColumn("Série");
        lista.addColumn("Qtd");
        lista.addColumn("Valor");
        lista.addColumn("Emissão");
        lista.addColumn("Terceiro");
        lista.addColumn("CNPJ");
        lista.addColumn("Natureza");
        lista.addColumn("CNPJ");
        lista.addColumn("Produto");
        lista.addColumn("NCM/SH");
        lista.addColumn("Destino");
        lista.addColumn("UF/Destino");
        lista.addColumn("NF Referenciada");

        ConsultaFB();

        try {
            while (fb.rs.next()) {

                try {
                    lista.addRow(new String[]{
                        fb.rs.getString(1),
                        fb.rs.getString(2),
                        fb.rs.getString(3),
                        fb.rs.getString(4),
                        dateIn.format(fb.rs.getDate(5)),
                        fb.rs.getString(6),
                        fb.rs.getString(7),
                        fb.rs.getString(8),
                        fb.rs.getString(9),
                        fb.rs.getString(10),
                        fb.rs.getString(11),
                        fb.rs.getString(12),
                        fb.rs.getString(13),
                        fb.rs.getString(14)});
                } catch (NullPointerException e) {
                    JOptionPane.showMessageDialog(this, e);
                }
            }
        } catch (SQLException ex) {

            JOptionPane.showMessageDialog(this, "Erro ao consultar o banco de dados: " + ex);
        } finally {
            fb.desconecta();

        }
    }

}
